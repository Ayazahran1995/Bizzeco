<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoLearn - Learn About Sustainable Brands</title>
    <style>
        :root {
            --primary: #2a9d8f;
            --secondary: #e9c46a;
            --background: #f8f9fa;
            --text: #264653;
            --correct: #52b788;
            --incorrect: #e76f51;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 30px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-emoji {
            font-size: 28px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes slideIn {
            from { transform: translateX(-50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .character {
            font-size: 60px;
            margin: 0 auto 20px;
            display: block;
            text-align: center;
            animation: pulse 3s infinite;
        }

        .character.happy {
            animation: bounce 2s infinite;
        }

        .character.thinking {
            animation: pulse 3s infinite;
        }

        .character.celebrating {
            animation: spin 3s infinite;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin: 20px 0;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--primary);
            border-radius: 20px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .brand-select {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center; /* Center brand cards */
        }

        .brand-card {
            flex: 1;
            min-width: 250px;
            max-width: 350px; /* Limit max width */
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .brand-card:hover {
            transform: translateY(-5px);
        }

        .brand-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .brand-emoji {
            font-size: 40px;
            margin-bottom: 10px;
            animation: pulse 2s infinite;
        }

        .brand-logo {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .lesson-container, .quiz-container, .result-container, .welcome-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
            display: inline-block;
            margin-top: 15px;
        }

        .btn:hover {
            background-color: #248277;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: #d4b144;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .quiz-option {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .quiz-option:hover {
            background: #e9e9e9;
            transform: translateY(-3px);
        }

        .quiz-option.selected {
            background: var(--secondary);
            font-weight: bold;
        }

        .option-emoji {
            margin-right: 10px;
            font-size: 20px;
        }

        .correct {
            background: var(--correct) !important;
            color: white;
        }

        .incorrect {
            background: var(--incorrect) !important;
            color: white;
        }

        .hidden {
            display: none;
        }

        .score-display {
            font-size: 20px; /* Slightly smaller in header */
            font-weight: bold;
            text-align: center;
            margin: 0; /* Remove margin */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px; /* Smaller gap */
        }

        .score-emoji {
            font-size: 24px; /* Smaller emoji */
            animation: pulse 2s infinite;
        }

        #userGreeting {
             font-size: 16px; /* Smaller greeting */
             font-weight: bold;
             color: var(--primary);
             text-align: right; /* Align right in header */
             margin-bottom: 5px;
             width: 100%; /* Take full width above score */
        }


        .lesson-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 15px 0;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title-emoji {
            font-size: 24px;
        }

        p {
            margin-bottom: 15px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--secondary);
            animation: confetti 5s ease-in-out infinite;
            z-index: 999;
            top: -10px; /* Start above the viewport */
            left: 0; /* Will be set by JS */
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .feedback-emoji {
            font-size: 50px;
            display: block;
            text-align: center;
            margin: 20px 0;
        }

        /* New Styles for Welcome/Name Input */
        .welcome-container {
            text-align: center;
        }

        .welcome-container input[type="text"] {
            padding: 10px;
            margin: 20px auto; /* Center the input */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            width: 80%;
            max-width: 300px;
            display: block; /* Make it a block element to center */
        }

         .welcome-container .character {
             font-size: 80px; /* Make character bigger in welcome */
         }

         header > div:last-child { /* Container for greeting and score */
             text-align: right;
             margin-left: auto; /* Push to the right */
         }


        @media (max-width: 600px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }

            .brand-select {
                flex-direction: column;
                align-items: center; /* Center items in column layout */
            }

            .brand-card {
                 width: 90%; /* Make cards wider on small screens */
                 min-width: unset; /* Remove min-width constraint */
            }

            header {
                flex-direction: column;
                align-items: flex-start;
            }

            header > div:last-child {
                margin-left: 0;
                width: 100%;
                text-align: left;
                margin-top: 10px;
            }

            #userGreeting {
                 text-align: left;
            }

            .score-display {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-emoji">ğŸŒ±</div>
                EcoLearn
            </div>
            <div> <div id="userGreeting"></div> <div class="score-display">
                    <div class="score-emoji">âœ¨</div>
                    Score: <span id="score">0</span>
                </div>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="welcomeContainer" class="welcome-container">
            <div class="character">ğŸ‘‹</div>
            <h2>Welcome to EcoLearn!</h2>
            <p>Learn about amazing brands leading the way in sustainability. Understanding these businesses is key to building a more sustainable future, and it's the foundation for **sustainable finance** â€“ directing money towards positive impact! ğŸŒğŸ’°</p>
            <p>Enter your name to save your progress:</p>
            <input type="text" id="userNameInput" placeholder="Your Name">
            <button class="btn" onclick="startApp()">Let's Start! <span class="title-emoji">ğŸš€</span></button>
        </div>


        <div id="brandSelect" class="brand-select">
            <h2 style="width: 100%; text-align: center; margin-bottom: 20px;">
                <span class="title-emoji">ğŸŒ</span> Choose a brand to learn about:
            </h2>
            <div class="character">ğŸ§ </div>
            <div class="brand-card" onclick="selectBrand('patagonia')">
                <div class="brand-emoji">ğŸ”ï¸</div>
                <h3>Patagonia</h3>
                <p>Learn about Patagonia's environmental activism and sustainable business practices.</p>
            </div>
            <div class="brand-card" onclick="selectBrand('tonys')">
                <div class="brand-emoji">ğŸ«</div>
                <h3>Tony's Chocolonely</h3>
                <p>Discover how Tony's is working to make chocolate 100% slave-free.</p>
            </div>
        </div>

        <div id="lessonContainer" class="lesson-container">
            <div class="character thinking" id="lessonCharacter">ğŸ¤”</div>
            <h2 id="lessonTitle"></h2>
            <div class="lesson-image" id="lessonImage">
                <img src="/api/placeholder/400/200" alt="Lesson Illustration" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            <div id="lessonContent"></div>
            <button class="btn" id="finishLessonBtn" onclick="nextLesson()">Next Lesson <span class="title-emoji">â¡ï¸</span></button>
             </div>

        <div id="quizContainer" class="quiz-container">
            <div class="character" id="quizCharacter">ğŸ§</div>
            <h2><span class="title-emoji">â“</span> Quick Quiz</h2>
            <p id="quizQuestion"></p>
            <div class="quiz-options" id="quizOptions"></div>
            <button class="btn hidden" id="checkAnswerBtn" onclick="checkAnswer()">Check Answer <span class="title-emoji">âœ…</span></button>
            <button class="btn hidden" id="nextQuestionBtn" onclick="nextQuestion()">Next Question <span class="title-emoji">â¡ï¸</span></button>
        </div>

        <div id="resultContainer" class="result-container">
            <div class="character happy" id="resultCharacter">ğŸ‰</div>
            <h2><span class="title-emoji">ğŸ†</span> Great job!</h2>
            <div class="score-display">You scored: <span id="finalScore"></span>%</div>
            <div id="feedbackEmoji" class="feedback-emoji"></div>
            <p id="resultFeedback"></p>

            <p style="margin-top: 25px;">
                 By learning about brands like Patagonia and Tony's Chocolonely, you're gaining insight into how businesses can prioritize people and the planet through strong ESG practices. âœ¨ This knowledge is valuable for everyone, especially as we think about a sustainable future, not just on Earth Day, but every day! ğŸŒ±
             </p>
            <button class="btn" onclick="returnToHome()">Learn More Brands <span class="title-emoji">ğŸ”„</span></button>
        </div>
    </div>

    <script>
        // App State - Now includes userName
        const state = {
            userName: null, // Added userName
            currentBrand: null,
            currentLesson: 0,
            currentQuiz: 0,
            score: 0,
            totalQuestions: 0, // Total questions asked in the current brand's quiz path
            correctAnswers: 0, // Correct answers in the current brand's quiz path
            selectedOption: null
        };

        // Brand Content - Includes the new final lesson on Double Materiality and ESG/term explanations
        const brands = {
            patagonia: {
                name: "Patagonia",
                emoji: "ğŸ”ï¸",
                lessonEmojis: ["ğŸŒ„", "â™»ï¸", "ğŸŒŠ", "ğŸ’¡"], // Added lightbulb emoji for the new lesson
                characterEmojis: ["ğŸ§—â€â™€ï¸", "ğŸŒ²", "ğŸï¸", "ğŸ§ "], // Changed character emoji for the new lesson
                lessons: [
                    {
                        title: "Patagonia: History & Mission",
                        emoji: "ğŸ“š",
                        content: `<p>Founded by Yvon Chouinard in 1973, Patagonia began as a small company making tools for climbers. Patagonia's mission statement is "We're in business to save our home planet." ğŸŒ</p>
                        <p>From the beginning, the company has been committed to making products that last and can be repaired, reducing consumption and waste. This philosophy forms the core of their sustainability approach. (This focus on environmental impact is a key part of their **Environmental (E)** practice!) â™»ï¸</p>
                        <p>In 2022, Chouinard transferred ownership of Patagonia to the Patagonia Purpose Trust and the Holdfast Collective, ensuring all profits not reinvested in the company go to fighting climate change. (This unique structure relates to their **Governance (G)** practices, ensuring the mission stays central.) ğŸŒ±</p>`
                    },
                    {
                        title: "Sustainable Materials & Practices",
                        emoji: "ğŸ§µ",
                        content: `<p>Patagonia is a pioneer in using recycled materials in their clothing. Many products use recycled polyester made from plastic bottles ğŸ¶, recycled wool, and organic cotton. (Using recycled and organic materials is a core **Environmental (E)** practice.)</p>
                        <p>Their Worn Wear program encourages customers to repair rather than replace gear. They offer detailed repair guides, sell repair kits, and have a dedicated repair facility that fixes over 40,000 items annually. (This extends the life of products and reduces waste - more **Environmental (E)** focus!) ğŸ§©</p>
                        <p>Patagonia was one of the first companies to switch to organic cotton in 1996, eliminating the use of synthetic pesticides and fertilizers in their cotton products. (Another example of prioritizing **Environmental (E)** health in their **Supply Chain** - the journey materials take from source to product.) ğŸŒ¿</p>`
                    },
                    {
                        title: "Environmental Activism",
                        emoji: "âœŠ",
                        content: `<p>Through their "1% for the Planet" commitment, Patagonia donates 1% of total sales to environmental nonprofits working on conservation and restoration. (Direct financial support for environmental causes is a strong **Environmental (E)** and **Social (S)** action!) ğŸ’š</p>
                        <p>The company actively engages in environmental campaigns, from protecting public lands to encouraging climate activism. They've even sued the federal government to protect national monuments. (Using their influence for environmental protection is a powerful **Environmental (E)** practice.) âš–ï¸</p>
                        <p>Patagonia's film division produces documentaries highlighting environmental issues, raising awareness. (Raising public awareness is both a **Social (S)** and **Environmental (E)** contribution.) ğŸ¬</p>`
                    },
                    // --- NEW CONCLUDING LESSON ---
                    {
                        title: "Why Sustainable Business Matters (The Double View!)",
                        emoji: "ğŸ’¡", // Lightbulb emoji
                        content: `<p>When we look at brands like Patagonia and Tony's, we learn about more than just products! We see **how** they impact the world around them (like reducing pollution - **E**, helping farmers - **S**, or being open - **G**).</p>
                        <p>But it goes the other way too! Things happening in the world (like climate change affecting resources, or people caring more about sustainability) can also seriously impact a company's money and future success. ğŸ’°ğŸŒ</p>
                        <p>Sustainable businesses understand this **"double view"** â€“ how their actions affect the world AND how the world affects their business financially. They manage their impact AND prepare for a changing future.</p>
                        <p>They think about all their **Stakeholders** â€“ everyone affected by the company (employees, suppliers, customers, communities, the planet) - not just the owners.</p>
                        <p>By focusing on strong **ESG** practices (Environmental, Social, Governance), these companies aren't just being "nice"; they are building **Long-term Value**. They manage risks (like scandals or supply issues) and attract customers and investors who care.</p>
                        <p>This "double view" is what sustainable finance analysts look for! Companies doing good for the world are often better prepared for the future. ğŸŒ±ğŸ“ˆ</p>
                        <p>Understanding how brands operate sustainably is the first step in understanding sustainable finance and making informed choices!</p>`
                    }
                    // --- END NEW CONCLUDING LESSON ---
                ],
                quizzes: [
                    {
                        question: "When was Patagonia founded? ğŸ“…",
                        options: ["1963", "1973", "1983", "1993"],
                        emojis: ["ğŸ•°ï¸", "ğŸ“†", "ğŸ“Š", "ğŸ“ˆ"],
                        correct: 1
                    },
                    {
                        question: "What percentage of sales does Patagonia donate to environmental nonprofits? ğŸ’°",
                        options: ["0.5%", "1%", "5%", "10%"],
                        emojis: ["ğŸ’²", "ğŸ’µ", "ğŸ’¸", "ğŸ’¹"],
                        correct: 1
                    },
                    {
                        question: "What material did Patagonia switch to in 1996? ğŸ§µ",
                        options: ["Recycled polyester", "Organic cotton", "Hemp", "Recycled wool"],
                        emojis: ["ğŸ‘•", "ğŸŒ±", "ğŸŒ¿", "ğŸ§¶"],
                        correct: 1
                    },
                    {
                        question: "What is Patagonia's program that encourages repairing gear? ğŸ”§",
                        options: ["Forever Wear", "Worn Wear", "Repair & Reuse", "Fix It First"],
                        emojis: ["ğŸ”„", "ğŸ‘š", "ğŸ§°", "ğŸ”¨"],
                        correct: 1
                    },
                    {
                        question: "Who founded Patagonia? ğŸ‘¤",
                        options: ["Doug Tompkins", "Yvon Chouinard", "Royal Robbins", "Jerry Moffatt"],
                        emojis: ["ğŸ‘¨â€ğŸ’¼", "ğŸ§—â€â™‚ï¸", "ğŸ§ ", "ğŸ§©"],
                        correct: 1
                    }
                ]
            },
            tonys: {
                name: "Tony's Chocolonely",
                emoji: "ğŸ«",
                lessonEmojis: ["ğŸ¤", "ğŸŒ", "ğŸ“Š", "ğŸ’¡"], // Added lightbulb emoji
                characterEmojis: ["ğŸ«", "ğŸ§", "ğŸª", "ğŸ§ "], // Changed character emoji
                lessons: [
                    {
                        title: "Tony's Mission & Origin",
                        emoji: "ğŸ”",
                        content: `<p>Tony's Chocolonely was founded in 2005 by Dutch journalist Teun van de Keuken ("Tony"), who was shocked to discover the prevalent use of child labor and modern slavery in cocoa production. ğŸ˜§</p>
                        <p>The company's mission is to make chocolate 100% slave-free, not just their own chocolate but all chocolate worldwide. (This is a deeply committed **Social (S)** mission!) Their name "Chocolonely" refers to Tony feeling "lonely" in his fight against inequality in the chocolate industry. ğŸ¤</p>
                        <p>Their unequally divided chocolate bars symbolize the inequality in the chocolate industry, with each segment representing the uneven distribution of profits in the **Supply Chain** (the journey of cocoa from farm to bar). (This design helps raise awareness - a **Social (S)** tool.) âš–ï¸</p>`
                    },
                    {
                        title: "Five Sourcing Principles",
                        emoji: "ğŸ“‹",
                        content: `<p>Tony's follows five key sourcing principles to create a more equitable cocoa **Supply Chain**: ğŸŒ±</p>
                        <p>1. <strong>Traceable beans:</strong> They know exactly where their cocoa comes from and who produces it. (This is key for **Transparency** and **Governance (G)**.) ğŸ”<br>
                        2. <strong>Higher prices:</strong> They pay a premium above market price directly to farmers. (This addresses economic inequality and is a core **Social (S)** practice - sometimes called a **Fair Price**.) ğŸ’°<br>
                        3. <strong>Strong farmers:</strong> They strengthen farmer cooperatives. (Empowering farmers is another **Social (S)** practice.) ğŸ’ª<br>
                        4. <strong>Long-term commitment:</strong> They commit to farmers for at least 5 years. (Provides stability for farmers - **Social (S)** - and strengthens the **Supply Chain**.) ğŸ“…<br>
                        5. <strong>Better quality and productivity:</strong> They help farmers improve their practices. (Benefits farmers - **Social (S)** - and can have environmental benefits - **Environmental (E)**.) ğŸ“ˆ</p>`
                    },
                    {
                        title: "Impact & Transparency",
                        emoji: "ğŸ“Š",
                        content: `<p>Tony's publishes an annual "FAIR" report detailing their impact, challenges, and progress toward their mission. They're transparent about where they succeed and where they need to improve. (This high level of **Transparency** is a key part of their **Governance (G)**.) ğŸ“</p>
                        <p>Through Tony's Open Chain, they share their sourcing model with other chocolate companies, believing collaboration is necessary to transform the industry. (Sharing knowledge for wider impact - **Social (S)** and **Governance (G)** leadership.) ğŸ¤</p>
                        <p>Their Child Labor Monitoring and Remediation System (CLMRS) actively identifies and remediates cases of child labor in their **Supply Chain**. (Directly addressing a critical **Social (S)** issue.) ğŸ‘¦ğŸ‘§</p>`
                    },
                     // --- SAME NEW CONCLUDING LESSON ---
                    {
                        title: "Why Sustainable Business Matters (The Double View!)",
                        emoji: "ğŸ’¡", // Lightbulb emoji
                        content: `<p>When we look at brands like Patagonia and Tony's, we learn about more than just products! We see **how** they impact the world around them (like reducing pollution - **E**, helping farmers - **S**, or being open - **G**).</p>
                        <p>But it goes the other way too! Things happening in the world (like climate change affecting resources, or people caring more about sustainability) can also seriously impact a company's money and future success. ğŸ’°ğŸŒ</p>
                        <p>Sustainable businesses understand this **"double view"** â€“ how their actions affect the world AND how the world affects their business financially. They manage their impact AND prepare for a changing future.</p>
                        <p>They think about all their **Stakeholders** â€“ everyone affected by the company (employees, suppliers, customers, communities, the planet) - not just the owners.</p>
                        <p>By focusing on strong **ESG** practices (Environmental, Social, Governance), these companies aren't just being "nice"; they are building **Long-term Value**. They manage risks (like scandals or supply issues) and attract customers and investors who care.</p>
                        <p>This "double view" is what sustainable finance analysts look for! Companies doing good for the world are often better prepared for the future. ğŸŒ±ğŸ“ˆ</p>
                        <p>Understanding how brands operate sustainably is the first step in understanding sustainable finance and making informed choices!</p>`
                    }
                    // --- END NEW CONCLUDING LESSON ---
                ]
            }
        };

        // Animated characters
        const characters = {
            default: "ğŸ§ ",
            thinking: "ğŸ¤”",
            question: "ğŸ§",
            correct: "ğŸ‰",
            incorrect: "ğŸ˜¢",
            success: "ğŸ¥³",
            learning: "ğŸ“š" // Character for lessons
        };

        // --- New localStorage Functions ---

        // Save the current state to localStorage
        function saveProgress() {
            try {
                // Check if localStorage is available before using it
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('ecoLearnState', JSON.stringify(state));
                    // console.log("Progress saved:", state); // For debugging
                } else {
                    // console.warn("localStorage is not available. Cannot save progress.");
                }
            } catch (e) {
                console.error("Failed to save progress to localStorage:", e);
                // Handle potential quota exceeded errors if needed
            }
        }

        // Load state from localStorage
        function loadProgress() {
            try {
                 // Check if localStorage is available before using it
                 if (typeof(Storage) === "undefined") {
                     // console.warn("localStorage is not available. Cannot load progress.");
                     return false;
                 }

                const savedState = localStorage.getItem('ecoLearnState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Basic validation to prevent loading corrupted data
                    if (parsedState && parsedState.userName !== undefined && parsedState.score !== undefined) {
                         // Ensure required properties exist, add defaults if missing from older saves
                         if (parsedState.totalQuestions === undefined) parsedState.totalQuestions = 0;
                         if (parsedState.correctAnswers === undefined) parsedState.correctAnswers = 0;
                         if (parsedState.currentLesson === undefined) parsedState.currentLesson = 0;
                         if (parsedState.currentQuiz === undefined) parsedState.currentQuiz = 0;


                         Object.assign(state, parsedState);
                        // console.log("Progress loaded:", state); // For debugging
                         return true; // Indicate that progress was loaded
                    }
                    console.warn("Saved state found but appears corrupted. Clearing.");
                    localStorage.removeItem('ecoLearnState'); // Clear potentially bad data
                }
            } catch (e) {
                 console.error("Failed to load progress from localStorage:", e);
                 localStorage.removeItem('ecoLearnState'); // Clear potentially bad data
            }
            return false; // Indicate no valid saved progress
        }

        // Display the user's greeting
        function displayGreeting() {
             const greetingElement = document.getElementById('userGreeting');
             if (state.userName) {
                 greetingElement.textContent = `Hey ${state.userName}! ğŸ‘‹`;
             } else {
                 greetingElement.textContent = ''; // Clear if no user
             }
        }

        // Start the app after getting user name or loading progress
        function startApp() {
            const userNameInput = document.getElementById('userNameInput');
            if (!state.userName) { // If user name is not already loaded
                 if (userNameInput && userNameInput.value.trim() !== "") { // Check if input exists and has value
                    state.userName = userNameInput.value.trim();
                    saveProgress(); // Save initial state with name
                 } else {
                    // This case should ideally be prevented by the initApp logic
                    console.error("startApp called without a user name or input value.");
                     return; // Don't proceed if no name is entered
                 }
            }


            document.getElementById('welcomeContainer').style.display = 'none';
            document.getElementById('brandSelect').style.display = 'flex'; // Show brand selection
            document.getElementById('score').textContent = state.score; // Update displayed score
            displayGreeting(); // Show personalized greeting
            updateProgress(); // Update progress bar based on loaded state

            // If user had started a brand before and was mid-progress, potentially resume
            // For simplicity here, we always return to brand select on initial load,
            // but the saved state will reflect their last progress point if they return to a brand.
        }

        // --- Modified Init Function ---

        // Initialize the app
        function initApp() {
            // Check if localStorage is available
             if (typeof(Storage) === "undefined") {
                 console.warn("localStorage is not available. Progress will not be saved.");
                 const greetingElement = document.getElementById('userGreeting');
                 if(greetingElement) greetingElement.textContent = "Progress saving not supported in this browser.";

                 const welcomeContainer = document.getElementById('welcomeContainer');
                 if(welcomeContainer) welcomeContainer.style.display = 'block';

                 const nameInput = document.getElementById('userNameInput');
                 if(nameInput) nameInput.style.display = 'none';

                 const startButton = document.querySelector('#welcomeContainer button');
                 if(startButton) {
                     startButton.textContent = "Start Learning (Progress won't save)";
                     startButton.onclick = () => { // Modify start button behavior
                          if(welcomeContainer) welcomeContainer.style.display = 'none';
                          if(document.getElementById('brandSelect')) document.getElementById('brandSelect').style.display = 'flex';
                          displayGreeting(); // Still display empty greeting or the warning message
                          updateProgress();
                     };
                 }
                 // Initialize score display even without saving
                 if(document.getElementById('score')) document.getElementById('score').textContent = state.score;
                 return; // Stop initialization if no storage
            }

            // If localStorage is available, try to load progress
            if (loadProgress()) {
                // If progress loaded, go directly to brand selection
                startApp(); // Call startApp to update UI based on loaded state

                // Optional: Add logic here to resume lesson/quiz if state indicates that
                // This requires more complex UI state management than currently implemented
                // (checking state.currentBrand, state.currentLesson, state.currentQuiz
                // and calling showLesson() or showQuiz() instead of just startApp())
                // For now, the app returns to brand select but keeps the score and last progress point saved.

            } else {
                // If no progress loaded, show the welcome/name input
                document.getElementById('welcomeContainer').style.display = 'block';
            }
             // Initialize score display even if no save is loaded yet
             if(document.getElementById('score')) document.getElementById('score').textContent = state.score;
        }

        // Create confetti effect (Same as before)
        function createConfetti() {
            const confettiCount = 100;
            const colors = ['#e9c46a', '#2a9d8f', '#f4a261', '#e76f51', '#264653'];

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.animationDelay = (Math.random() * 2) + 's';
                document.body.appendChild(confetti);

                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // Select a brand to learn about (Slight modification to save progress)
        function selectBrand(brand) {
            state.currentBrand = brand;
            state.currentLesson = 0; // Start from the first lesson for the selected brand
            state.currentQuiz = 0;
            state.totalQuestions = 0; // Reset quiz stats for new brand path
            state.correctAnswers = 0;
            state.score = 0; // Reset score for the new brand path

            document.getElementById('score').textContent = state.score; // Update header score

            saveProgress(); // Save state after selecting a brand

            showLesson();

            document.getElementById('brandSelect').style.display = 'none';
            document.getElementById('lessonContainer').style.display = 'block';

            updateProgress();
        }

         // Show current lesson (Modified to handle quiz/finish button)
        function showLesson() {
            const brand = brands[state.currentBrand];
            if (!brand) {
                 console.error("No brand selected or brand data missing.");
                 returnToHome(); // Go back to home if state is invalid
                 return;
            }

            // Check if we've gone past the last lesson index
            if (state.currentLesson >= brand.lessons.length) {
                 // If all lessons are done, proceed to quizzes
                 state.currentQuiz = 0; // Start quizzes for this brand path
                 showQuiz();
                 return;
            }

            const lesson = brand.lessons[state.currentLesson];

            document.getElementById('lessonTitle').innerHTML = `<span class="title-emoji">${lesson.emoji}</span> ${lesson.title}`;
            document.getElementById('lessonContent').innerHTML = lesson.content;

            // Update character
            document.getElementById('lessonCharacter').textContent = brand.characterEmojis[state.currentLesson % brand.characterEmojis.length];

            // Control the button visibility and text
            const finishLessonBtn = document.getElementById('finishLessonBtn');
            finishLessonBtn.style.display = 'inline-block'; // Always show this button during lessons

            // If this is the last lesson before quizzes, change the button text
            if (state.currentLesson === brand.lessons.length - 1) {
                 // Check if there are quizzes for this brand path before changing text
                 if (brand.quizzes && brand.quizzes.length > 0) {
                    finishLessonBtn.innerHTML = `Take Quiz <span class="title-emoji">ğŸ“</span>`;
                 } else {
                     // If no quizzes, maybe go directly to results after this lesson?
                     finishLessonBtn.innerHTML = `Finish Brand <span class="title-emoji">ğŸ†</span>`;
                 }

            } else {
                 finishLessonBtn.innerHTML = `Next Lesson <span class="title-emoji">â¡ï¸</span>`;
            }


            updateProgress();
        }

        // Function to move from one lesson to the next
        function nextLesson() {
            const brand = brands[state.currentBrand];
             if (!brand) return;

             // If we are on the LAST lesson, clicking the button should go to QUIZ or RESULTS
            if (state.currentLesson === brand.lessons.length - 1) {
                // Check if there are quizzes for this brand path
                 if (brand.quizzes && brand.quizzes.length > 0) {
                     // Go to quiz
                     state.currentLesson++; // Increment lesson just past the last lesson
                     state.currentQuiz = 0; // Start quizzes
                     showQuiz();
                 } else {
                     // No quizzes, go straight to results
                     state.currentLesson++; // Increment lesson just past the last lesson
                     showResult();
                 }

            } else {
                 // If there are more lessons, go to the next lesson
                 state.currentLesson++;
                 showLesson(); // Load the next lesson
            }
             saveProgress(); // Save progress after completing a lesson/moving step
        }


        // Show quiz after lesson (Called by nextLesson or finishLessonBtn when it means "Take Quiz")
        function showQuiz() {
            const brand = brands[state.currentBrand];
             // Check if there are quizzes for this brand
            if (!brand || !brand.quizzes || brand.quizzes.length === 0) {
                 // If no quizzes defined, this function shouldn't ideally be called,
                 // but as a fallback, go to results or return home.
                 console.warn("showQuiz called but no quizzes defined for this brand.");
                 showResult(); // Or returnToHome();
                 return;
            }

            document.getElementById('lessonContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';

            // Update character
            document.getElementById('quizCharacter').textContent = characters.question;

            loadQuizQuestion();
            // saveProgress(); // Save state when starting the quiz - maybe save after first answer is better/less frequent
        }

        // Load current quiz question (Same as before)
        function loadQuizQuestion() {
            const brand = brands[state.currentBrand];
             if (!brand || !brand.quizzes || state.currentQuiz >= brand.quizzes.length) {
                console.error("Attempted to load quiz question beyond array bounds or brand data missing.");
                showResult(); // Go to results if state is invalid
                return;
            }

            const quiz = brand.quizzes[state.currentQuiz];

            document.getElementById('quizQuestion').textContent = quiz.question;

            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = '';

            quiz.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.innerHTML = `<span class="option-emoji">${quiz.emojis[index]}</span> ${option}`;
                optionElement.setAttribute('data-index', index);
                optionElement.onclick = () => selectOption(index);
                optionsContainer.appendChild(optionElement);
            });

            document.getElementById('checkAnswerBtn').classList.remove('hidden');
            document.getElementById('nextQuestionBtn').classList.add('hidden');

            state.selectedOption = null;

            // Re-enable options that were disabled after checking answer
             const options = document.querySelectorAll('.quiz-option');
             options.forEach(option => {
                 option.style.pointerEvents = 'auto';
                 option.classList.remove('correct', 'incorrect', 'selected'); // Clean up previous state
             });

             updateProgress(); // Update progress bar during quiz
        }

        // Select a quiz option (Same as before)
        function selectOption(index) {
            state.selectedOption = index;

            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.classList.remove('selected');
            });

            options[index].classList.add('selected');
        }

        // Check the selected answer (Modified to save progress)
        function checkAnswer() {
            if (state.selectedOption === null) return;

            const brand = brands[state.currentBrand];
             if (!brand || !brand.quizzes || state.currentQuiz >= brand.quizzes.length) return; // Safety check

            const quiz = brand.quizzes[state.currentQuiz];

            const options = document.querySelectorAll('.quiz-option');

            // Disable options after selection
             options.forEach(option => {
                 option.style.pointerEvents = 'none';
             });

            // Show correct answer
            options[quiz.correct].classList.add('correct');

            // Update character based on answer
            if (state.selectedOption !== quiz.correct) {
                options[state.selectedOption].classList.add('incorrect');
                document.getElementById('quizCharacter').textContent = characters.incorrect;
            } else {
                // If correct, increase score
                state.score += 10; // Increased points per correct answer
                state.correctAnswers++;
                document.getElementById('score').textContent = state.score;
                document.getElementById('quizCharacter').textContent = characters.correct;
            }

            document.getElementById('checkAnswerBtn').classList.add('hidden');
            document.getElementById('nextQuestionBtn').classList.remove('hidden');

            state.totalQuestions++; // Only count questions that were answered

            saveProgress(); // Save progress after checking answer
        }

        // Go to next question or finish quiz (Modified to save progress and handle lesson/result transition)
        function nextQuestion() {
            state.currentQuiz++;

             const brand = brands[state.currentBrand];
             if (!brand || !brand.quizzes) {
                 showResult(); // Go to results if state is invalid
                 return;
            }

            // If there are more questions for this brand's quiz set
            if (state.currentQuiz < brand.quizzes.length) {
                 // Reset character for the next question
                document.getElementById('quizCharacter').textContent = characters.question;
                loadQuizQuestion(); // Load the next question
            } else {
                // If all quizzes for this brand path are done, move to the next lesson or show results
                state.currentLesson++; // Increment lesson to move past the quiz step
                 state.currentQuiz = 0; // Reset quiz index for the next lesson's potential quiz (if any)

                if (state.currentLesson < brand.lessons.length) {
                    // If there are more lessons (like the final concluding one)
                    document.getElementById('quizContainer').style.display = 'none';
                    document.getElementById('lessonContainer').style.display = 'block';
                    showLesson(); // Load the next lesson
                } else {
                    // If all lessons and quizzes for this brand path are done, show results
                    showResult();
                }
            }
            saveProgress(); // Save progress after moving to next question/lesson/result
        }

        // Show quiz result
        function showResult() {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('lessonContainer').style.display = 'none'; // Ensure lesson is hidden too
            document.getElementById('resultContainer').style.display = 'block';

            // Calculate percentage based on total questions for THIS brand path
            const percentage = state.totalQuestions === 0 ? 0 : Math.round((state.correctAnswers / state.totalQuestions) * 100);
            document.getElementById('finalScore').textContent = percentage;

            const feedbackEmojiElement = document.getElementById('feedbackEmoji');
            const resultFeedbackElement = document.getElementById('resultFeedback');

            // Determine feedback based on percentage, using the userName
            if (percentage >= 80) {
                document.getElementById('resultCharacter').textContent = characters.success;
                feedbackEmojiElement.textContent = 'ğŸŒŸ';
                resultFeedbackElement.textContent = `Amazing, ${state.userName}! You really know your sustainable brands!`;
                createConfetti(); // Add confetti for high score
            } else if (percentage >= 50) {
                 document.getElementById('resultCharacter').textContent = characters.happy;
                feedbackEmojiElement.textContent = 'ğŸ‘';
                resultFeedbackElement.textContent = `Good effort, ${state.userName}! Keep learning to improve your score.`;
            } else {
                document.getElementById('resultCharacter').textContent = characters.thinking;
                feedbackEmojiElement.textContent = 'ğŸ¤”';
                resultFeedbackElement.textContent = `You're just getting started, ${state.userName}! Review the lessons and try again.`;
            }

            // Reset quiz stats for the next brand or round
            state.totalQuestions = 0;
            state.correctAnswers = 0;
             // Don't reset state.currentBrand here immediately, keep it for showing result message context if needed.
             // It gets reset when returning to home.

            saveProgress(); // Save final score and current state
        }

        // Return to home/brand selection (Modified to reset brand state)
        function returnToHome() {
             document.getElementById('resultContainer').style.display = 'none';
             document.getElementById('brandSelect').style.display = 'flex';
             document.getElementById('score').textContent = state.score; // Ensure score is updated in header

             // Reset state for selecting a new brand path
             state.currentBrand = null;
             state.currentLesson = 0;
             state.currentQuiz = 0;
             state.totalQuestions = 0;
             state.correctAnswers = 0;
             state.selectedOption = null; // Reset selected option state

             saveProgress(); // Save state after returning home (clears current brand context)

             // Reset progress bar
             document.getElementById('progressBar').style.width = '0%';
        }

        // Update the progress bar (Modified calculation)
        function updateProgress() {
            const brand = brands[state.currentBrand];
            if (!brand) {
                 document.getElementById('progressBar').style.width = '0%';
                 return;
            }

            const totalLessons = brand.lessons.length;
            const totalQuizzes = brand.quizzes.length;
            const totalSections = totalLessons + totalQuizzes; // Each lesson and each quiz represents a 'step'

            let completedSteps = state.currentLesson; // Count completed lessons as steps

            // If we have finished all lessons and are currently in the quiz phase:
            if (state.currentLesson === totalLessons) {
                 completedSteps += state.currentQuiz; // Add completed quizzes as steps
            }


            const progressPercentage = totalSections === 0 ? 0 : (completedSteps / totalSections) * 100;


            document.getElementById('progressBar').style.width = progressPercentage + '%';
        }

        // --- Initial App Load ---
        // Call initApp when the page finishes loading
        window.onload = initApp;


    </script>
</body>
</html>
